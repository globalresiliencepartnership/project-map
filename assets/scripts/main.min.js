window.Grp={Models:{},Collections:{},Views:{},Routers:{},init:function(){"use strict";Grp.router=new Grp.Routers.Router,Backbone.history.start()}},$(document).ready(function(){"use strict";L.mapbox.accessToken="pk.eyJ1IjoiZ2xvYmFscmVzaWxpZW5jZXBhcnRuZXJzaGlwIiwiYSI6ImNpazV5bXpkYTAwZDNpZm0yMjAxanFzem0ifQ.U2KL82hmIJNr8Sf1R2vTXw",Parse.initialize("8zbh9doCtxZXGe9tOtdJKkhamoOTtYupuT2nk3KQ","yYCLA97XA6xDh5FyoKo3a2Yoaf7L4y6bAWxJL5V0"),Grp.init()}),Grp.Models=Grp.Models||{},function(){"use strict";Grp.Models.Location=Parse.Object.extend({className:"Location"})}(),Grp.Models=Grp.Models||{},function(){"use strict";Grp.Models.Project=Parse.Object.extend({className:"Project"})}(),Grp.Models=Grp.Models||{},function(){"use strict";Grp.Models.TourItem=Parse.Object.extend({className:"Tour"})}(),Grp.Routers=Grp.Routers||{},function(){"use strict";Grp.Routers.Router=Backbone.Router.extend({routes:{"add-project":"addProject","*default":"start"},start:function(){$("#site-canvas").unbind(),Grp.View=new Grp.Views.Map},addProject:function(){$("#site-canvas").unbind(),console.log("dhb"),Grp.View=new Grp.Views.ProjectForm}})}(),Grp.Views=Grp.Views||{},function(){"use strict";Grp.Views.Map=Backbone.View.extend({el:"#site-canvas",template:JST["map.ejs"],mapGeojson:null,projectIds:[],projects:[],tourItems:[],sidebarView:null,tourView:null,currentTourItem:0,currentProj:null,clickTimer:null,map:null,markerClusterLayer:null,markerAggregateLayer:null,filteredMarkersLayer:null,markerNearbyZone:null,nearbyMarkersLayer:null,tooltipTemplate:JST["map-tooltip.ejs"],initialize:function(){var a=this;this.processApiData(function(b,c,d){a.mapGeojson=c,a.tourItems=_.sortBy(d,function(a){return a.attributes.Weight}),a.render()})},render:function(){var a=this;this.$el.html(this.template()),this.sidebarView=new Grp.Views.Sidebar,this.tourView=new Grp.Views.Tour,$("#more-info").popover({trigger:"hover"}),a.tourView.setData(a.tourItems[0].attributes).render(),console.log(a.tourItems),this.map=L.mapbox.map("map","globalresiliencepartnership.p26a3dl1",{maxZoom:12,minZoom:2,zoomControl:!1}).on("ready",function(){new L.Control.Zoom({position:"topright"}).addTo(a.map),new L.Control.MiniMap(L.mapbox.tileLayer("devseed.la1fieg0"),{zoomLevelFixed:2,aimingRectOptions:{color:"#26C9FF",weight:3,fill:!1}}).addTo(a.map)}),window.map=this.map,this.markerClusterLayer=new L.MarkerClusterGroup({showCoverageOnHover:!1,spiderfyOnMaxZoom:!0,iconCreateFunction:function(a){return new L.DivIcon({className:"marker cluster",iconSize:[],html:"<p>"+a.getChildCount()+"</p>"})}}),console.log(a.mapGeojson);var b=[],c=[],d=[];$.each(a.mapGeojson.features,function(a,e){console.log(e.properties.region),b.push(e.properties.project.substring(0,30)),c.push(e.properties.city),d.push(e.properties.country)});var e=_.unique(c);$.each(e,function(a,b){console.log(b),$("#select-city-filter").append('<option value="'+b+'">'+b+"</option>")});var f=_.unique(d);$.each(f,function(a,b){console.log(b),$("#select-country-filter").append('<option value="'+b+'">'+b+"</option>")});var g=_.unique(b);return $.each(g,function(a,b){console.log(b),$("#select-project-filter").append('<option value="'+b+'">'+b+"</option>")}),$("#select-facet-filter").selectmenu(),$("#select-city-filter").selectmenu(),$("#select-country-filter").selectmenu(),$("#select-project-filter").selectmenu(),$("#select-city-filter-button, #select-project-filter-button").hide(),$(".ui-icon").addClass("ui-icon-white"),this.map.setView([0,0],2),this.filteredMarkersLayer=this.getFilteredMarkers(null),this.markerClusterLayer.addLayer(this.filteredMarkersLayer),this.map.addLayer(this.markerClusterLayer),this.addEventListeners(),this},addEventListeners:function(){var a=this;return this.sidebarView.bind("nav:up",this.sidebarNavUpBtnClick,this).bind("nav:prev",this.sidebarNavPrevBtnClick,this).bind("nav:next",this.sidebarNavNextBtnClick,this).bind("nav:about",this.sidebarNavAboutBtnClick,this).bind("nav:search",this.sidebarNavSearchBtnClick,this).bind("nav:searchQuery",this.sidebarNavSearchQuery,this),this.tourView.bind("tour:next",this.tourNavNextBtnClick,this).bind("tour:prev",this.tourNavPrevBtnClick,this),this.map.on("zoomend",function(){var a=map.getZoom();$("body").attr("id","zoom-"+a)}),$(document).on("click","#close-about",function(a){$("#about").removeClass("revealed")}),$(document).on("click","#reset",function(b){b.preventDefault(),$("#search-box").val(""),a.sidebarNavSearchQuery(),a.map.setView([0,0],2)}),$("#select-facet-filter").selectmenu({change:function(a,b){"City"===b.item.value&&($("#select-country-filter-button, #select-project-filter-button").hide(),$("#select-city-filter-button").show()),"Country"===b.item.value&&($("#select-city-filter-button, #select-project-filter-button").hide(),$("#select-country-filter-button").show()),"Project"===b.item.value&&($("#select-city-filter-button, #select-country-filter-button").hide(),$("#select-project-filter-button").show())}}),$("#select-city-filter").selectmenu({change:function(b,c){$("#search-box").val(c.item.value),a.sidebarNavSearchQuery()}}),$("#select-country-filter").selectmenu({change:function(b,c){$("#search-box").val(c.item.value),a.sidebarNavSearchQuery()}}),$("#select-project-filter").selectmenu({change:function(b,c){$("#search-box").val(c.item.value),a.sidebarNavSearchQuery()}}),$("#map").on("click",".view-more",function(b){b.preventDefault(),$(".tour-cntrl, #sidebar .tour").hide(),$("#sidebar .project").show();var c=$(this).data("pid").toString();console.log("PID",c),a.currentProj=_.findWhere(a.projects,{id:c}),a.filterByPid(c),console.log("Clicked marker props",a.currentProj),a.sidebarView.setData(a.currentProj.attributes).render()}),this},sidebarNavUpBtnClick:function(){this.resetMarkers(),$("#sidebar, .tour-cntrl, #sidebar .tour").show(),$("#sidebar .project").hide()},sidebarNavNextBtnClick:function(){console.log("projectIds",this.projectIds);var a=_.indexOf(this.projectIds,this.currentProj.id);console.log("currentPid",this.projectIds);var b=a+1,c=b>=this.projectIds.length?this.projectIds[0]:this.projectIds[b];console.log("currentPid",c),this.currentProj=_.findWhere(this.projects,{id:c}),console.log("currentProj",this.currentProj),this.filterByPid(this.currentProj.id),this.sidebarView.setData(this.currentProj.attributes).render()},sidebarNavPrevBtnClick:function(){console.log("projectIds",this.projectIds);var a=_.indexOf(this.projectIds,this.currentProj.id);console.log("currentPid",this.projectIds);var b=a-1,c=0>b?this.projectIds[this.projectIds.length-1]:this.projectIds[b];console.log("currentPid",c),this.currentProj=_.findWhere(this.projects,{id:c}),console.log("currentProj",this.currentProj),this.filterByPid(this.currentProj.id),this.sidebarView.setData(this.currentProj.attributes).render()},tourNavPrevBtnClick:function(){this.currentTourItem--;var a=this.tourItems.length;console.log(this.currentTourItem),-1==this.currentTourItem&&(this.currentTourItem=a-1);var b=this.tourItems[this.currentTourItem].attributes.location,c=this.tourItems[this.currentTourItem].attributes.zoom;this.map.setView([b.latitude,b.longitude],c),this.tourView.setData(this.tourItems[this.currentTourItem].attributes).render()},tourNavNextBtnClick:function(){this.currentTourItem++;var a=this.tourItems.length;this.currentTourItem>=a&&(this.currentTourItem=0);var b=this.tourItems[this.currentTourItem].attributes.location,c=this.tourItems[this.currentTourItem].attributes.zoom;this.map.setView([b.latitude,b.longitude],c),this.tourView.setData(this.tourItems[this.currentTourItem].attributes).render()},sidebarNavAboutBtnClick:function(){$("#about").addClass("revealed")},sidebarNavSearchBtnClick:function(){console.log("Search!"),$("#search").fadeIn()},sidebarNavSearchQuery:function(){function a(a){return"city"===b?-1!==a.properties.city.toLowerCase().indexOf(c):"project"===b?-1!==a.properties.project.toLowerCase().indexOf(c):"country"===b?-1!==a.properties.country.toLowerCase().indexOf(c):"region"===b?-1!==a.properties.region.toLowerCase().indexOf(c):"international partner"===b?-1!==a.properties.partnersint.toLowerCase().indexOf(c):void 0}var b=$("#select-facet-filter").find(":selected").val().toLowerCase(),c=$("#search-box").val().toLowerCase();console.log(b),this.filteredMarkersLayer.setFilter(a);var d=this;this.filteredMarkersLayer.eachLayer(function(a){var b=a.feature.properties,c=L.divIcon({className:"marker single",iconSize:[],popupAnchor:[-6,-12]});a.setIcon(c);var e=d.tooltipTemplate(b);a.bindPopup(e)}),this.map.fitBounds(this.filteredMarkersLayer.getBounds())},resetMarkers:function(){return this.cleanMap(),this.filteredMarkersLayer=this.getFilteredMarkers(null),this.markerClusterLayer.addLayer(this.filteredMarkersLayer),this.map.addLayer(this.markerClusterLayer).fitBounds(this.filteredMarkersLayer.getBounds()),this},cleanMap:function(){return this.map.removeLayer(this.filteredMarkersLayer).removeLayer(this.markerClusterLayer),this.markerClusterLayer.clearLayers(),this.nearbyMarkersLayer&&(this.map.removeLayer(this.nearbyMarkersLayer),this.map.removeLayer(this.nearbyMarkersZoneLayer)),this},filterByPid:function(a){this.cleanMap(),this.filteredMarkersLayer=this.getFilteredMarkers(a);this.filteredMarkersLayer.toGeoJSON();return this.map.addLayer(this.filteredMarkersLayer).fitBounds(this.filteredMarkersLayer.getBounds(),{padding:[200,200]}),this},getNearbyMarkers:function(a){var b=this,c=L.mapbox.featureLayer().setGeoJSON(this.mapGeojson);return c.setFilter(function(c){var d=!1;return b.filteredMarkersLayer.eachLayer(function(a){_.isEqual(c,a.toGeoJSON())&&(d=!0)}),d?!1:turf.inside(c,a.features[0])}),c.eachLayer(function(a){var c=a.feature.properties;console.log(c);var d=L.divIcon({className:"marker single secondary",iconSize:[],popupAnchor:[-6,-12]});a.setIcon(d);var e=b.tooltipTemplate(c);a.bindPopup(e)}),c},getFilteredMarkers:function(a){var b=this,c=L.mapbox.featureLayer().setGeoJSON(this.mapGeojson);return a&&c.setFilter(function(b){return b.properties.pid==a}),c.eachLayer(function(a){var c=a.feature.properties,d=L.divIcon({className:"marker single",iconSize:[],popupAnchor:[-6,-12]});a.setIcon(d);var e=b.tooltipTemplate(c);a.bindPopup(e)}),c},processApiData:function(a){var b=this,c=new Parse.Query(Grp.Models.Project);c.equalTo("published",1);var d=new Parse.Query(Grp.Models.Location);d.matchesQuery("project",c),d.include("project");var e=new Parse.Query(Grp.Models.TourItem);async.parallel([function(a){e.find({success:function(b){a(null,b)},error:function(b){a(b.message)}})}],function(c,e){if(c)throw new Error(c);var f=e[0];async.parallel([function(a){d.find({success:function(b){a(null,b)},error:function(b){a(b.message)}})}],function(c,d){if(c)throw new Error(c);var e=d[0],g={type:"FeatureCollection",features:[]};e.forEach(function(a){var c=a.get("project");-1==b.projectIds.indexOf(c.id)&&(b.projects.push(c),b.projectIds.push(c.id));var d={type:"Feature",geometry:{type:"Point",coordinates:[]},properties:{}};d.properties=c.attributes,d.properties.pid=c.id;var e=a.get("location");d.geometry.coordinates=[e.longitude,e.latitude];var f=a.get("city");d.properties.city=f;var h=a.get("country");d.properties.country=h,g.features.push(d)}),a(null,g,f)})})}})}(),Grp.Views=Grp.Views||{},function(){"use strict";Grp.Views.ProjectForm=Backbone.View.extend({el:"#site-canvas",template:JST["project-form.ejs"],templateLocation:JST["project-form-location.ejs"],events:{},data:null,initialize:function(){var a=this;$.get("country_centroids.json").success(function(b){a.centroids=b,a.render(),a.addEventListeners()})},render:function(){this.$el.html(this.template());var a=this.addLocationSelection();return a.find(".remove").removeClass("revealed"),this},addLocationSelection:function(){var a=$(this.templateLocation({countries:this.centroids}));return this.$el.find("#proj-locations").append(a),a},addEventListeners:function(){var a=this,b=this.$el.find("#proj-locations");return b.on("click",".remove",function(a){a.preventDefault(),$(this).parents(".location").remove()}),this.$el.find(".add").click(function(b){b.preventDefault(),a.addLocationSelection()}),b.on("change",'select[name="location[country][]"]',function(b){var c=$(this).val(),d=$(this).parents(".location"),e=d.data("map");if(!e){var f=d.find(".map");f.addClass("revealed"),e=L.mapbox.map(f[0],"examples.map-i86nkdio"),e.scrollWheelZoom.disable();var g=null;e.on("click",function(a){d.find('input[name="location[long][]"]').val(a.latlng.lng),d.find('input[name="location[lat][]"]').val(a.latlng.lat),g?g.setLatLng(a.latlng):g=L.marker(a.latlng).addTo(e)}),d.data("map",e)}e.setView([a.centroids[c].coordinates[1],a.centroids[c].coordinates[0]],9)}),$('#project-submission input[name="project_submit"]').click(function(b){b.preventDefault(),$("#project-submission .error").remove();var c=!0,d=$('input[name="name"]'),e=d.val();$.trim(e)||(c=!1,0===d.siblings(".error").length&&d.parent().append('<small class="error">Project title is required.</small>'));var f=$('select[name="focusarea"]'),g=f.val();console.log(g),"--"==g&&(c=!1,0===f.siblings(".error").length&&f.parent().append('<small class="error">Focus Area is required.</small>'));var h=$('input[name="resp_email"]'),i=h.val();$.trim(i)||(c=!1,0===h.siblings(".error").length&&h.parent().append('<small class="error">Email is required.</small>'));var j=$('input[name="url"]'),k=j.val();$.trim(k)||(c=!1,0===j.siblings(".error").length&&j.parent().append('<small class="error">Project url is required.</small>'));var l=$('textarea[name="proj_description"]'),m=l.val();$.trim(m)||(c=!1,0===l.siblings(".error").length&&l.parent().append('<small class="error">Project description is required.</small>'));var n=[],o=$("#project-submission .location");if(o.each(function(){var a=[],b=$(this),d=parseFloat(b.find('input[name="location[lat][]"]').val()),e=parseFloat(b.find('input[name="location[long][]"]').val()),f=b.find('select[name="location[country][]"]').val();return"--"==f&&(c=!1,a.push("Country is required")),(isNaN(d)||isNaN(e))&&(c=!1,a.push("Latitude or longitude is invalid")),c?void n.push({latlng:{latitude:d,longitude:e},country:f}):(b.find(".error").remove(),void b.append('<small class="error">'+a.join(" / ")+"</small>"))}),c){var p=new Grp.Models.Project;p.set("project",e),p.set("focusarea",g),p.set("resp_email",i),p.set("url",k),p.set("description",m),p.set("published",0),n.forEach(function(b){var c=new Parse.GeoPoint(b.latlng),d=new Grp.Models.Location;d.set("location",c),d.set("project",p),d.set("country",a.centroids[b.country].name),d.set("countryCode",b.country),d.save()}),a.resetForm(),$("#project-submission .error").remove()}}),this},resetForm:function(){var a=this.addLocationSelection();return a.find(".remove").removeClass("revealed"),this.$el.find("#project-submission form")[0].reset(),this.$el.find("#proj-locations").html("").append(a),this}})}(),Grp.Views=Grp.Views||{},function(){"use strict";Grp.Views.Sidebar=Backbone.View.extend({el:"#sidebar",template:JST["sidebar.ejs"],events:{"click #nav-up":"navUpBtnClick","click #nav-prev":"navPrevBtnClick","click #nav-next":"navNextBtnClick","click #nav-about":"navAboutBtnClick","click #nav-search":"navSearchBtnClick","change #search-box":"navSearchKeyup","keyup #search-box":"navSearchKeyup"},data:null,initialize:function(){},setData:function(a){var b=a.partnerslocal.split("; ");return this.data=a,this.data.partners=b,this},render:function(){return console.log("sidebar data",this.data),this.$el.find(".project").html(this.template(this.data)),this.$el.addClass("revealed"),this.$el.find(".project-cntrl").addClass("revealed"),this},navUpBtnClick:function(a){a.preventDefault(),this.$el.find(".project-cntrl").removeClass("revealed"),this.trigger("nav:up")},navPrevBtnClick:function(a){a.preventDefault(),this.trigger("nav:prev")},navNextBtnClick:function(a){a.preventDefault(),this.trigger("nav:next")},navAboutBtnClick:function(a){a.preventDefault(),this.trigger("nav:about")},navSearchBtnClick:function(a){a.preventDefault(),this.trigger("nav:search")},navSearchKeyup:function(a){a.preventDefault(),this.trigger("nav:searchQuery")}})}(),Grp.Views=Grp.Views||{},function(){"use strict";Grp.Views.Tour=Backbone.View.extend({el:"#sidebar",template:JST["tour.ejs"],events:{"click #tour-prev":"tourPrevBtnClick","click #tour-next":"tourNextBtnClick"},data:null,initialize:function(){},setData:function(a){return this.data=a,console.log(a),this},render:function(){return console.log("tour data",this.data),this.$el.find(".tour").html(this.template(this.data)),this.$el.addClass("revealed"),this},tourPrevBtnClick:function(a){a.preventDefault(),this.trigger("tour:prev")},tourNextBtnClick:function(a){a.preventDefault(),this.trigger("tour:next")}})}();
//# sourceMappingURL=main.min.js.map