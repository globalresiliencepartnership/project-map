window.GPR={Models:{},Collections:{},Views:{},Routers:{},init:function(){"use strict";GPR.router=new GPR.Routers.App,Backbone.history.start(),$("#overlay").stop().fadeOut(100)}},$(document).ready(function(){"use strict";GPR.init()}),GPR.Views=GPR.Views||{},function(){"use strict";GPR.Views.Country=Backbone.View.extend({initialize:function(){this.loaded=!1,this.zoomLimit=5},render:function(){"undefined"!=typeof this.layer?this.addLayer():(this.listenToOnce(this.collection,"loaded",this.firstLoad),this.collection.query())},addLayer:function(){"undefined"!=typeof this.layer?this.layer.addTo(GPR.map):this.render()},removeLayer:function(){GPR.map.hasLayer(this.layer)&&GPR.map.removeLayer(this.layer)},firstLoad:function(){this.getmap(),this.layer.addTo(GPR.map),this.addZoom()},addZoom:function(){var a=this;GPR.map.on("zoomend",function(){var b=GPR.map.getZoom();b>=a.zoomLimit&&GPR.map.hasLayer(a.layer)&&(GPR.locationView.addLayer(),GPR.countryView.removeLayer()),b<a.zoomLimit&&a.loaded&&(GPR.map.hasLayer(a.layer)||(GPR.locationView.removeLayer(),GPR.countryView.addLayer()))})},removeZoom:function(){GPR.map.off("zoomend")},getmap:function(){var a,b=new L.Popup({className:"wax-tooltip",autoPanPadding:0,closeButton:!1,offset:L.point(0,-10)}),c=this,d=L.geoJson(this.collection.response,{pointToLayer:function(a,b){return L.circleMarker(b,c.collection.marker)},onEachFeature:function(c,d){d.on({mousemove:function(c){var d=c.target.feature.properties;b.setLatLng(c.latlng),b.setContent("<div class='section heading'><h2>"+d.country+"</h2><div class='connections-total'>Budget:<span class='value'>"+d.total_budget+"</span></div></div><ul class='section connections clearfix'><li class='seeking'>Projects<span class='value'>"+d.total_projects+"</span></li><li class='providing'>Partners <span class='value'>"+d.total_partners+"</span></li><li class='both'>Locations<span class='value'>"+d.total_locations+"</span></li></ul>"),b._map||b.openOn(GPR.map),window.clearTimeout(a)},mouseout:function(){a=window.setTimeout(function(){GPR.map.closePopup()},100)},click:function(a){GPR.router.navigate("country/"+a.target.feature.properties.country,{trigger:!0})}})}});this.layer=d}})}(),GPR.Views=GPR.Views||{},function(){"use strict";GPR.Views.Projects=Backbone.View.extend({el:"#overlay",initialize:function(){},load:function(a){if(this.query=a,"undefined"!=typeof this.collection.response)this.render();else{var b=this;this.collection.fetch({success:function(){b.render()}})}},render:function(){var a=_.find(this.collection.response.features,function(a){return this.query==a.properties.country},this),b=a.properties,c=_.template($("#modal").html()),d=_.template($("#stats").html());this.$el.html(c({id:1,title:b.country,mainTitle:b.country,stats:d({projects:b.total_projects,partners:b.total_partners,locations:b.total_locations}),content:this.list(b)})),$("#overlay").stop().fadeIn(200)},list:function(a){var b=_.template($("#projects-list").html());return b({projects:GPR.projects.where({Country:a.country})})}})}(),GPR.Views=GPR.Views||{},function(){"use strict";GPR.Views.Map=Backbone.View.extend({el:"#overlay",events:{"click a.close":"closeModal"},initialize:function(){},render:function(){L.mapbox.accessToken=this.model.get("token");var a=L.mapbox.map("map",this.model.get("base"),{zoomControl:!1}).setView(this.model.get("view"),this.model.get("zoom"));new L.Control.Zoom({position:"topright"}).addTo(a);return a},addCountry:function(){GPR.countryView.addLayer()},closeModal:function(a){var b=$(a.currentTarget).closest(".modal");b.addClass("bye");var c=function(){b.remove()},d=$(a.currentTarget).attr("data-nested");return d?c():(setTimeout(c,500),$("#overlay").fadeOut(200)),window.history.back(),!1}})}(),GPR.Views=GPR.Views||{},function(){"use strict";GPR.Views.Location=Backbone.View.extend({initialize:function(){},load:function(a){"undefined"==typeof this.layer&&("prepare"==a&&this.listenToOnce(this.collection,"loaded",this.getmap),"render"==a&&this.listenToOnce(this.collection,"loaded",this.render),this.collection.query())},render:function(){"undefined"==typeof this.layer&&(this.getmap(),this.layer.addTo(GPR.map))},addLayer:function(){"undefined"!=typeof this.layer&&this.layer.addTo(GPR.map)},removeLayer:function(){GPR.map.hasLayer(this.layer)&&GPR.map.removeLayer(this.layer)},getmap:function(){var a,b=new L.Popup({className:"wax-tooltip",autoPanPadding:0,closeButton:!1,offset:L.point(0,-10)}),c=this,d=L.geoJson(this.collection.attributes,{pointToLayer:function(a,b){return L.circleMarker(b,c.collection.marker)},onEachFeature:function(c,d){d.on({mousemove:function(c){var d=c.target.feature.properties;b.setLatLng(c.latlng),b.setContent("<div class='section heading'><h2>"+d.program_name+"</h2><div class='connections-total'>"+d.city+", "+d.country+"</div><p>Implementer: <strong>"+d.implementer+"</strong></p><p>2014 Budget: <strong>"+d.fy14_contrib+"</strong></p><p>"+d.notes+"</p></div>"),b._map||b.openOn(GPR.map),window.clearTimeout(a)},mouseout:function(){a=window.setTimeout(function(){GPR.map.closePopup()},100)},click:function(a){new GPR.Views.Projects(a.target.feature.properties);GPR.router.navigate("country/"+a.target.feature.properties.country,{trigger:!0})}})}});this.layer=d}})}(),GPR.Models=GPR.Models||{},function(){"use strict";GPR.Models.Country=Backbone.Model.extend({})}(),GPR.Models=GPR.Models||{},function(){"use strict";GPR.Models.Map=Backbone.Model.extend({defaults:{token:"pk.eyJ1Ijoic2Npc2NvIiwiYSI6InVEREpQdjQifQ.jsWwLl3hdVM1n0DtcLY54w",base:"wbiknowledge.world-bank-border",view:[15,20],zoom:3}})}(),GPR.Models=GPR.Models||{},function(){"use strict";GPR.Models.Project=Backbone.Model.extend({})}(),GPR.Models=GPR.Models||{},function(){"use strict";GPR.Models.Location=Backbone.Model.extend({urlRoot:"/grp-map/data/locations.geojson",marker:{radius:10,weight:4,color:"#DEEBF7",opacity:.7,fillColor:"#ff0000",fillOpacity:.7},initialize:function(){},query:function(){var a=this;this.fetch({success:function(b){a.attributes=b.attributes,a.trigger("loaded")}})}})}(),GPR.Collections=GPR.Collections||{},function(){"use strict";GPR.Collections.Projects=Backbone.Collection.extend({url:"/grp-map/data/projects.json",initialize:function(){var a=this;this.fetch({success:function(){a.trigger("loaded")}})}})}(),GPR.Collections=GPR.Collections||{},function(){"use strict";GPR.Collections.Countries=Backbone.Collection.extend({url:"/grp-map/data/country_level_list.geojson",marker:{radius:15,weight:4,color:"#DEEBF7",opacity:.7,fillColor:"#4292C5",fillOpacity:.7},initialize:function(){},query:function(){var a=this;this.fetch({success:function(b,c){a.response=c,a.trigger("loaded")}})}})}(),GPR.Routers=GPR.Routers||{},function(){"use strict";function a(){b=!0,GPR.projects=new GPR.Collections.Projects({}),GPR.locations=new GPR.Models.Location({}),GPR.countries=new GPR.Collections.Countries({}),GPR.countryView=new GPR.Views.Country({collection:GPR.countries}),GPR.locationView=new GPR.Views.Location({collection:GPR.locations}),GPR.projectsView=new GPR.Views.Projects({collection:GPR.countries});var a=new GPR.Models.Map({});GPR.mapview=new GPR.Views.Map({model:a}),GPR.map=GPR.mapview.render()}var b=!1;GPR.Routers.App=Backbone.Router.extend({routes:{"":"newload","country/:name":"modal",locations:"locations"},newload:function(){b||a(),GPR.locationView.load("prepare"),GPR.countryView.loaded=!0,GPR.map.getZoom()<=5&&(GPR.locationView.removeLayer(),GPR.countryView.addLayer()),$(".sector-navigation a#location").removeClass("active"),$(".sector-navigation a#country").addClass("active")},modal:function(c){b||a(),this.newload(),GPR.projectsView.load(c)},locations:function(){b||a(),GPR.locationView.load("render"),GPR.countryView.loaded=!1,GPR.locationView.addLayer(),GPR.countryView.removeLayer(),$(".sector-navigation a#country").removeClass("active"),$(".sector-navigation a#location").addClass("active")}})}();